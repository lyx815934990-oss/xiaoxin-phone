# 微信应用文件结构

## 架构说明

微信应用采用**模块化架构**，遵循**全局监听 → 应用解析 → 数据处理 → UI展示**的清晰流程。

### 消息处理流程

```
全局监听器 (utils/message-listener.js)
    ↓ 识别微信相关格式
微信解析器 (api/parser.js)
    ↓ 解析指令
数据处理器 (api/data-handler.js)
    ↓ 更新数据
UI模块 (ui/*.js)
    ↓ 刷新界面
```

**重要**：微信应用**不进行重复的消息监听**，而是通过全局监听器统一处理，然后由解析器接收并处理。

## 根目录 (`app/wechat/`)

- **`wechat-app.js`**:
  - **职责**: 应用主入口文件
  - **范畴**:
    - 初始化整个微信应用
    - 加载和协调下属的各个模块（UI、API、状态管理）
    - 管理应用的主视图切换（聊天列表、通讯录、朋友圈、我的）
    - **不进行消息监听**（由全局监听器统一处理）
    - 注册解析器到全局监听器，接收解析后的数据并更新UI

- **`wechat-app.css`**:
  - **职责**: 全局样式文件
  - **范畴**:
    - 定义微信应用的主题、颜色、字体等基础样式
    - 存放可以在多个模块间共享的通用样式类

## API 模块 (`app/wechat/api/`)

*此目录负责数据处理和与全局工具的交互。*

- **`parser.js`**:
  - **职责**: 微信消息解析器
  - **范畴**:
    - **接收全局监听器**（`utils/message-listener.js`）分发的消息
    - 解析微信相关的特殊格式，例如：
      - `[wx_contact]...[/wx_contact]` - 联系方式标签（使用方括号格式，避免被HTML处理）
      - `[WX:CHAT:SEND:user_id:message_content]` - 聊天消息指令
      - `[WX:MOMENTS:NEW:post_content]` - 朋友圈发布指令
    - 调用 `data-handler.js` 来更新数据
    - 触发自定义事件通知 UI 模块进行界面刷新
  - **注意**：此文件不进行DOM监听，只负责解析已接收到的消息内容

- **`data-handler.js`**:
  - **职责**: 微信数据处理器
  - **范畴**:
    - 作为微信应用与 `utils/data-manager.js` 之间的桥梁
    - 封装所有微信相关的数据操作：
      - 获取/保存聊天记录
      - 增删联系人
      - 管理朋友圈数据
      - 切换用户数据
    - 为其他模块提供清晰的数据访问接口（如 `getChatHistory(userId)`, `addContact(contactInfo)`）

## UI 模块 (`app/wechat/ui/`)

*此目录负责所有用户界面的渲染和交互逻辑。*

- **`chat.js`**:
  - **职责**: 聊天界面模块
  - **范畴**:
    - 渲染私聊和群聊的界面
    - 显示消息列表，包括时间戳
    - 实现"对方正在输入中..."的效果
    - 处理用户发送消息的逻辑
    - 实现语音/视频通话的UI展示和交互

- **`contacts.js`**:
  - **职责**: 通讯录和朋友管理模块
  - **范畴**:
    - 渲染联系人列表
    - 实现添加朋友的界面和逻辑
    - 管理联系人详情页和权限设置（如消息免打扰、朋友圈权限）

- **`moments.js`**:
  - **职责**: 朋友圈模块
  - **范畴**:
    - 渲染朋友圈信息流
    - 实现发布、点赞、评论的界面和交互逻辑

- **`components.js`**:
  - **职责**: 可复用 UI 组件库
  - **范畴**:
    - 封装通用的小组件，如：新消息弹窗（微信内/外）、红点提示、确认对话框、加载动画等
    - 供其他 UI 模块调用

## 状态管理模块 (`app/wechat/state/`)

*此目录负责管理应用的动态状态。*

- **`account.js`**:
  - **职责**: 用户账户管理
  - **范畴**:
    - 处理微信账号的注册、登录和切换逻辑
    - 管理当前登录的用户信息

- **`store.js`**:
  - **职责**: 应用全局状态存储
  - **范畴**:
    - 存储整个应用的当前状态，例如：当前活动聊天窗口的 ID、所有联系人的未读消息数
    - 当状态变更时（如收到新消息），负责通知相关的 UI 模块更新视图（例如更新红点）

## 文件加载顺序

根据 `index.js` 的加载逻辑，文件按以下顺序加载：

1. `utils/data-manager.js` - 数据管理工具（必须先加载）
2. `utils/message-listener.js` - 全局消息监听器
3. `utils/image-api.js` - 生图API工具
4. `mobile-phone.js` - 手机核心逻辑
5. `app/wechat/state/account.js` - 微信账号管理
6. `app/wechat/api/data-handler.js` - 微信数据处理器
7. `app/wechat/ui/contacts.js` - 通讯录UI模块
8. `app/wechat/wechat-app.js` - 微信应用主入口
9. `app\wechat\ui\message-queue.js` 独立的消息显示队列管理器
**注意**：`api/parser.js` 应在 `wechat-app.js` 中按需加载或初始化。
